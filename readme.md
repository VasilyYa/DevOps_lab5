# Лаб5. Docker basics

Создать образ и запустить контейнер:

- внутри которого будет работать веб-сервер Nginx,

- отдающий статическую html страницу с приветствием с порта,

- для доступа снаружи к nginx по сети пробросить в контейнер порт 54321

- команду запуска контейнера оформить шелл-скриптом

Дополнительное задание:

- Сгенерировать SSL самоподписанный сертификат

- Запускать nginx в контейнере с HTTPS протоколом, с сертификатом

- Сертификат пробросить в контейнер через Volume Mapping

- Сделать скрипт обновления (пересоздания сертификата), который будет давать внутрь докера команду nginx на перечитывание сертификата (reload)

# Лог выполнения задания:

1. Создаем статическую html страницу (index.html) в корне директории лабы.

2. Создаем dockerfile.

3. Создаем самоподписанный сертификат в директории cert лабы (для доп. задания). 
Используем OpenSSL - на выходе сертификат cert.pem и приватный ключ key.pem.

> openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -sha256 -days 30 -nodes -subj "/C=XX/ST=PermskiyKrai/L=Perm/O=DevOpsCompany/OU=AAA/CN=nginx-devops"

4. Создаем конфиг nginx (nginx.conf) в корне директории лабы. Заполняем в нем необходимые директивы. В том числе создаем секцию для https-запросов (для доп. задания)

5. Билдим докер-образ согласно dockerfile.

> docker build -t nginx-devops .

(nginx-devops - тег/метка)

6. Создаем и запускаем контейнер

> docker run -d --name nginx-devops-container -p 4321:80 -p 4322:443 -v /home/dev5/lab5/cert:/etc/nginx/ssl:ro --restart unless-stopped nginx-devops

7. Проверяем работу nginx для запросов по http и https:

> curl http://127.0.0.1:4321

> curl --insecure https://127.0.0.1:4322

8. Пишем скрипт scripts/renew-ssl-cert.sh, пересоздающий сертификат, заменяющий его в директории с сертификатом cert и перезагружающий конфигурацию nginx в контейнере. 

9. Проверяем, руками запуская скрипт и осуществляя запросы по п.7. Также проверяем сроки действия сертификата с помощью команды

> echo | openssl s_client -connect 127.0.0.1:4322 -servername 127.0.0.1 -showcerts 2>/dev/null | openssl x509 -noout -dates

Данный скрипт можно далее поставить на cron, либо модифицировать, добавив в него проверку срока действия сертификата перед обновлением на новый.


